<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Full Installation Schedule with Progress Tracking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .tab-button {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #e5e7eb;
            color: #4b5563;
            border-radius: 8px 8px 0 0;
            border: 1px solid #d1d5db;
            border-bottom: none;
            margin-right: 4px;
        }
        .tab-button.active {
            background-color: white;
            color: #1d4ed8;
            font-weight: 600;
            border-bottom: 1px solid white;
            margin-bottom: -1px;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        table {
            border-collapse: collapse;
            width: 100%;
        }
        th, td {
            text-align: left;
            padding: 12px 15px;
            border-bottom: 1px solid #e5e7eb;
            vertical-align: middle;
        }
        thead th {
            background-color: #f9fafb;
            font-weight: 600;
            color: #4b5563;
            cursor: pointer;
            position: relative;
        }
        .work-done-input {
            width: 80px;
            padding: 4px 8px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
        }
        .progress-bar-container {
            width: 100%;
            background-color: #e5e7eb;
            border-radius: 9999px;
            position: relative;
            height: 24px;
        }
        .progress-bar {
            background-color: #22c55e;
            height: 100%;
            border-radius: 9999px;
            transition: width 0.3s ease-in-out;
        }
        .progress-text {
            position: absolute;
            width: 100%;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            text-align: center;
            font-size: 12px;
            font-weight: 500;
            color: #1f2937;
        }
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn-secondary {
            background-color: #e5e7eb;
            color: #4b5563;
            border: 1px solid #d1d5db;
        }
        .btn-secondary:hover {
            background-color: #d1d5db;
        }
        .btn-danger {
            background-color: #fee2e2;
            color: #b91c1c;
            border: 1px solid #fecaca;
        }
        .btn-danger:hover {
            background-color: #fecaca;
        }
        .btn-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .btn-success:hover {
            background-color: #c3e6cb;
        }
        .filter-select {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background-color: white;
        }
        /* Working Days Chart Styles */
        .working-days-table {
            border-collapse: collapse;
            width: 100%;
            table-layout: fixed;
        }
        .working-days-table th, .working-days-table td {
            border: 1px solid #e5e7eb;
            padding: 4px 2px;
            text-align: center;
            font-size: 10px;
        }
        .working-days-table th:first-child {
            width: 120px;
        }
        .working-day-cell {
            color: #1e40af;
            font-weight: 500;
            cursor: pointer;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-screen-xl mx-auto">
        
        <div id="tabs-container" class="flex border-b border-gray-300">
            <button class="tab-button active" data-tab="dashboard">Dashboard</button>
            <button class="tab-button" data-tab="details">Schedule Details</button>
            <button class="tab-button" data-tab="teamWorkingDays">Team Working Days</button>
            <button class="tab-button" data-tab="teamProgress">Team Progress</button>
            <button class="tab-button" data-tab="sCurve">S-Curve</button>
            <button class="tab-button" data-tab="floorProgress">Floor Progress</button>
            <button class="tab-button" data-tab="histograms">Resource Histograms</button>
        </div>

        <div id="dashboard" class="tab-content active bg-white p-6 rounded-b-xl rounded-tr-xl shadow-md">
            <header class="mb-6">
                <h1 class="text-3xl font-bold text-gray-800">Project Dashboard</h1>
                <p class="text-gray-600 mt-1">Live progress tracking against the plan for July 2025</p>
            </header>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl border border-gray-200">
                    <h3 class="font-semibold text-gray-700">Total Planned</h3>
                    <p id="totalPlanned" class="text-2xl font-bold text-blue-600 mt-2">0 Lm</p>
                    <p class="text-xs text-gray-500 mt-1">as per take off sheet</p>
                </div>
                <div class="bg-white p-6 rounded-xl border border-gray-200">
                    <h3 class="font-semibold text-gray-700">Total Work Done</h3>
                    <p id="totalDone" class="text-2xl font-bold text-green-600 mt-2">0 Lm</p>
                </div>
                <div class="bg-white p-6 rounded-xl border border-gray-200">
                    <h3 class="font-semibold text-gray-700">Overall Progress</h3>
                    <div class="w-full bg-gray-200 rounded-full h-5 mt-3 relative">
                         <div id="overallProgressBar" class="bg-green-500 h-5 rounded-full" style="width: 0%;"></div>
                         <span id="overallProgressText" class="absolute inset-0 flex items-center justify-center text-sm font-bold text-gray-800">0%</span>
                    </div>
                </div>
            </div>
             <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Area Release Status</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                        <h4 class="font-semibold text-blue-800">Area Claimed Released</h4>
                        <p class="text-2xl font-bold text-blue-700 mt-1">3705.619 Lm</p>
                        <p class="text-sm font-medium text-blue-600">70.11% of Total Plan</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                        <h4 class="font-semibold text-green-800">Actually Available</h4>
                        <p class="text-2xl font-bold text-green-700 mt-1">362.068 Lm</p>
                        <p class="text-sm font-medium text-green-600">6.85% of Total Plan</p>
                    </div>
                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                        <h4 class="font-semibold text-yellow-800">Under Installation</h4>
                        <p class="text-2xl font-bold text-yellow-700 mt-1">1142.834 Lm</p>
                        <p class="text-sm font-medium text-yellow-600">21.62% of Total Plan</p>
                    </div>
                    <div class="bg-gray-100 p-4 rounded-lg border border-gray-200">
                        <h4 class="font-semibold text-gray-800">Total Actual</h4>
                        <p class="text-2xl font-bold text-gray-700 mt-1">1504.902 Lm</p>
                        <p class="text-sm font-medium text-gray-600">28.47% of Total Plan</p>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-1 gap-8">
                <div>
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Project S-Curve</h2>
                    <canvas id="sCurveChartDashboard"></canvas>
                </div>
                <div>
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Upcoming Tasks (Next 7 Days)</h2>
                    <div id="upcomingTasks" class="overflow-y-auto h-64 border rounded-lg p-4"></div>
                </div>
            </div>
        </div>

        <div id="details" class="tab-content bg-white p-6 rounded-b-xl rounded-tr-xl shadow-md">
            <div class="flex flex-wrap gap-4 justify-between items-center mb-4">
                <div class="flex flex-wrap gap-4 items-center"> 
                    <button id="RefreshBtn" class="btn btn-success">Refresh Data</button>
                    <select id="teamFilter" class="filter-select"><option value="All">All Teams</option></select>
                    <select id="floorFilter" class="filter-select"><option value="All">All Floors</option></select>
                    <select id="groupFilter" class="filter-select"><option value="All">All Groups</option></select>
                    <button id="clearFiltersBtn" class="btn btn-secondary">Clear Filters</button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table id="scheduleTable">
                    <thead>
                        <tr>
                            <th data-sort-index="0">Team ID</th>
                            <th data-sort-index="1">Task #</th>
                            <th data-sort-index="2">Assignment</th>
                            <th data-sort-index="3">Inst. Group</th>
                            <th data-sort-index="4">Floor</th>
                            <th data-sort-index="5">Planned (Lm)</th>
                            <th data-sort-index="6">Start Date</th>
                            <th data-sort-index="7">End Date</th>
                            <th>Work Done (Lm)</th>
                            <th style="min-width: 150px;">Progress</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
        
        <div id="teamWorkingDays" class="tab-content bg-white p-6 rounded-b-xl rounded-tr-xl shadow-md">
             <div id="working-days-container" class="overflow-x-auto"></div>
        </div>

        <div id="sCurve" class="tab-content bg-white p-6 rounded-b-xl rounded-tr-xl shadow-md">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Project S-Curve (Planned vs. Actual)</h2>
            <canvas id="sCurveChartDetail"></canvas>
        </div>

        <div id="floorProgress" class="tab-content bg-white p-6 rounded-b-xl rounded-tr-xl shadow-md">
             <h2 class="text-xl font-semibold text-gray-800 mb-4">Floor-by-Floor Progress</h2>
             <canvas id="floorProgressChart"></canvas>
        </div>

        <div id="teamProgress" class="tab-content bg-white p-6 rounded-b-xl rounded-tr-xl shadow-md">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Team Progress (Planned vs. Done)</h2>
            <canvas id="teamProgressChart"></canvas>
        </div>

        <div id="histograms" class="tab-content bg-white p-6 rounded-b-xl rounded-tr-xl shadow-md">
            <div class="grid grid-cols-1 gap-8">
                <div>
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Daily Manpower Histogram</h2>
                    <canvas id="manpowerChart"></canvas>
                </div>
                <div>
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Daily Equipment Histogram</h2>
                    <canvas id="equipmentChart"></canvas>
                </div>
            </div>
        </div>

    </div>

            <script type="module">
                const database_client = supabase.createClient(
                'https://setlixynpiaxmmvlkpbk.supabase.co', // Replace with your Supabase URL
                'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNldGxpeHlucGlheG1tdmxrcGJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE0NTIzODEsImV4cCI6MjA2NzAyODM4MX0.p2Noy6ukSYpvS8pJJsJoZjtylLF3Yf6ynKI36vLrSDA' // Replace with your Supabase anon key
                );
                // Assuming this code is inside an async function
    /*             async function fetchScheduleWorkDone() {
                try {
                    // Perform the query
                    const { data, error } = await database_client
                    .from('schedule_workdone_table')
                    .select();

                    // Check for errors
                    if (error) {
                    console.error('Error fetching data:', error.message);
                    return;
                    }

                    // Check if data exists
                    if (data && data.length > 0) {
                    // Loop through the data (array of objects)
                    data.forEach((row) => {
                        console.log('Unique ID:', row.uniqueId);
                        console.log('Work Done:', row.workDone);
                    });
                    } else {
                    console.log('No data found in schedule_workdone_table');
                    }
                } catch (err) {
                    console.error('Unexpected error:', err);
                }
                } */

                // Call the function
                /* fetchScheduleWorkDone(); */
                // --- SCRIPT SCOPE ---
                (function() {


                    // --- CONSTANTS ---
                    const STORAGE_KEY = 'installationProgressData';
                    const TEAM_COUNT = 23; 
                    const TEAM_PRODUCTIVITY = 7.5;
                    const START_DATE = new Date('2025-07-01T00:00:00Z');
                    const installationData = [
                        {id:57,l:155.987,f:'N/A'},{id:58,l:537.987,f:'N/A'},{id:59,l:10.973,f:'2F'},{id:60,l:20.157,f:'3F'},{id:61,l:15.713,f:'3F'},{id:62,l:20.154,f:'4F'},{id:63,l:15.714,f:'4F'},{id:64,l:20.158,f:'5F'},{id:65,l:15.714,f:'5F'},{id:66,l:19.56,f:'6F'},{id:67,l:15.721,f:'6F'},{id:68,l:12.184,f:'1F'},{id:69,l:12.181,f:'2F'},{id:70,l:22.56,f:'8F'},{id:71,l:15.715,f:'3F'},{id:72,l:24.362,f:'8F'},{id:73,l:15.713,f:'4F'},{id:74,l:24.357,f:'5F'},{id:75,l:15.719,f:'5F'},{id:76,l:24.36,f:'6F'},{id:77,l:15.721,f:'6F'},{id:78,l:10.98,f:'1F'},{id:79,l:12.181,f:'2F'},{id:80,l:20.158,f:'3F'},{id:81,l:15.711,f:'3F'},{id:82,l:24.358,f:'4F'},{id:83,l:15.717,f:'4F'},{id:84,l:24.36,f:'5F'},{id:85,l:15.711,f:'5F'},{id:86,l:24.356,f:'6F'},{id:87,l:15.711,f:'6F'},{id:88,l:21.44,f:'N/A'},{id:89,l:15.719,f:'N/A'},{id:90,l:24.023,f:'N/A'},{id:91,l:15.719,f:'N/A'},{id:92,l:24.362,f:'N/A'},{id:93,l:15.712,f:'N/A'},{id:94,l:10.98,f:'1F'},{id:95,l:12.18,f:'2F'},{id:96,l:22.119,f:'3F'},{id:97,l:15.709,f:'3F'},{id:98,l:24.356,f:'4F'},{id:99,l:15.71,f:'4F'},{id:100,l:24.362,f:'5F'},{id:101,l:15.71,f:'5F'},{id:102,l:24.358,f:'6F'},{id:103,l:15.711,f:'6F'},{id:104,l:12.18,f:'1F'},{id:105,l:12.181,f:'2F'},{id:106,l:22.559,f:'3F'},{id:107,l:15.712,f:'3F'},{id:108,l:24.359,f:'4F'},{id:109,l:15.712,f:'4F'},{id:110,l:24.362,f:'5F'},{id:111,l:15.709,f:'5F'},{id:112,l:24.359,f:'6F'},{id:113,l:15.705,f:'6F'},{id:114,l:10.98,f:'2F'},{id:115,l:20.159,f:'3F'},{id:116,l:15.713,f:'3F'},{id:117,l:20.157,f:'4F'},{id:118,l:15.711,f:'4F'},{id:119,l:20.16,f:'5F'},{id:120,l:15.711,f:'5F'},{id:121,l:19.56,f:'6F'},{id:122,l:15.719,f:'6F'},{id:123,l:16.311,f:'1F'},{id:124,l:48.676,f:'2F'},{id:125,l:45.336,f:'3F'},{id:126,l:19.461,f:'4F'},{id:127,l:48.628,f:'5F'},{id:128,l:99.144,f:'6F'},{id:129,l:43.611,f:'1F'},{id:130,l:49.676,f:'2F'},{id:131,l:51.538,f:'3F'},{id:132,l:18.461,f:'4F'},{id:133,l:54.989,f:'5F'},{id:134,l:99,f:'6F'},{id:135,l:33.446,f:'3F'},{id:136,l:15.243,f:'4F'},{id:137,l:14.796,f:'3F'},{id:138,l:16.246,f:'4F'},{id:139,l:16.311,f:'1F'},{id:140,l:48.676,f:'2F'},{id:141,l:51.536,f:'3F'},{id:142,l:18.461,f:'4F'},{id:143,l:55.004,f:'5F'},{id:144,l:99.005,f:'6F'},{id:145,l:43.61,f:'1F'},{id:146,l:48.675,f:'2F'},{id:147,l:51.536,f:'3F'},{id:148,l:18.459,f:'4F'},{id:149,l:54.828,f:'5F'},{id:150,l:98.845,f:'6F'},{id:151,l:171.523,f:'Z13 COR'},{id:152,l:34.56,f:'GF'},{id:153,l:34.56,f:'1F'},{id:154,l:34.56,f:'2F'},{id:155,l:34.56,f:'3F'},{id:156,l:34.56,f:'4F'},{id:157,l:34.56,f:'5F'},{id:158,l:40.991,f:'N/A'},{id:159,l:34.56,f:'GF'},{id:160,l:34.56,f:'1F'},{id:161,l:34.56,f:'2F'},{id:162,l:34.56,f:'3F'},{id:163,l:34.56,f:'4F'},{id:164,l:34.56,f:'5F'},{id:165,l:171.525,f:'Z14 COR'},{id:166,l:158.366,f:'6F'},{id:167,l:158.369,f:'6F'},{id:168,l:198.539,f:'7F'},{id:169,l:61.871,f:'7F'},{id:170,l:198.534,f:'7F'},{id:171,l:58.371,f:'6F'},{id:172,l:58.365,f:'6F'},{id:173,l:23.615,f:'N/A'},
                    {id:201, l:103.8, f:'Misc'}, {id:202, l:75.0, f:'Misc'}, {id:203, l:97.5, f:'Misc'}, {id:204, l:0.3, f:'Misc'}, {id:205, l:212.4, f:'Misc'}, {id:206, l:71.0, f:'Misc'}, {id:207, l:42.0, f:'Misc'}
                ];
                
                // --- GLOBAL VARIABLES ---
                let allTasks = [];
                let teams = [];
                let teamProgressChart, sCurveChartDashboard, sCurveChartDetail, floorProgressChart, manpowerChart, equipmentChart;

                // --- SCHEDULING LOGIC & HELPERS ---
                const addDays = (date, days) => { const r = new Date(date); r.setUTCDate(r.getUTCDate() + days); return r; };
                const getNextWorkDay = (date) => { return addDays(date, 1); };
                
                function formatDate(date) {
                    const year = date.getUTCFullYear();
                    const month = String(date.getUTCMonth() + 1).padStart(2, '0');
                    const day = String(date.getUTCDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }

                function parseFloor(floorStr) {
                    if (!floorStr) return { num: null, isNumeric: false };
                    if (floorStr.toUpperCase() === 'GF') return { num: 0, isNumeric: true };
                    const match = floorStr.match(/(\d+)/);
                    if (match) return { num: parseInt(match[0]), isNumeric: true };
                    return { num: null, isNumeric: false };
                }

                function calculateSchedule() {
                    let localTeams = Array.from({ length: TEAM_COUNT }, (_, i) => ({ id: i + 1, availableDate: START_DATE, tasks: [], startingFloor: null }));
                    let unassignedTasks = installationData.map(d => ({...d, floorInfo: parseFloor(d.f) }));
                    let initialTaskCount = unassignedTasks.length;
                    let primaryLoopCount = 0;
                    while(primaryLoopCount < initialTaskCount){
                        primaryLoopCount++;
                        let taskAssignedInLoop = false;
                        for (let i = 0; i < unassignedTasks.length; i++) {
                            const task = unassignedTasks[i];
                            const eligibleTeams = localTeams.filter(team => {
                                if (team.startingFloor === null) return true;
                                if (!task.floorInfo.isNumeric) return true;
                                if(team.startingFloor === 'Special') return !task.floorInfo.isNumeric;
                                const floor = task.floorInfo.num;
                                return floor >= team.startingFloor - 1 && floor <= team.startingFloor + 1;
                            });
                            if (eligibleTeams.length > 0) {
                                eligibleTeams.sort((a, b) => a.availableDate - b.availableDate);
                                const bestTeam = eligibleTeams[0];
                                const duration = Math.ceil(task.l / TEAM_PRODUCTIVITY);
                                const startDate = new Date(bestTeam.availableDate);
                                const endDate = addDays(startDate, duration - 1);
                                
                                bestTeam.tasks.push({ ...task, startDate, endDate, duration, assignmentType: 'Primary' });
                                bestTeam.availableDate = getNextWorkDay(endDate);
                                if (bestTeam.startingFloor === null) {
                                    bestTeam.startingFloor = task.floorInfo.isNumeric ? task.floorInfo.num : 'Special';
                                }
                                unassignedTasks.splice(i, 1);
                                taskAssignedInLoop = true;
                                break;
                            }
                        }
                        if(!taskAssignedInLoop) break;
                    }
                    unassignedTasks.forEach(task => {
                        localTeams.sort((a, b) => a.availableDate - b.availableDate);
                        const bestTeam = localTeams[0];
                        const duration = Math.ceil(task.l / TEAM_PRODUCTIVITY);
                        const startDate = new Date(bestTeam.availableDate);
                        const endDate = addDays(startDate, duration - 1);
                        bestTeam.tasks.push({ ...task, startDate, endDate, duration, assignmentType: 'Floating' });
                        bestTeam.availableDate = getNextWorkDay(endDate);
                    });
                    return localTeams;
                }

                function processTasks(teamsData) {
                    let processedTasks = [];
                    teamsData.sort((a,b) => a.id - b.id).forEach(team => {
                        team.tasks.forEach((task, index) => {
                            processedTasks.push({
                                uniqueId: `t${team.id}-s${index}`, teamId: team.id,
                                taskSequence: index + 1, assignmentType: task.assignmentType, group: task.id,
                                floor: task.f, length: task.l, startDate: task.startDate, endDate: task.endDate, workDone: 0,
                                duration: task.duration 
                            });
                        });
                    });
                    return processedTasks;
                }

                // --- LOAD, & RENDER ---


                function showAlert(message, type = 'success') {
                // Remove existing alerts to avoid stacking
                const existingAlert = document.querySelector('.custom-alert');
                if (existingAlert) existingAlert.remove();

                // Create alert div
                const alertDiv = document.createElement('div');
                alertDiv.className = `custom-alert fixed top-4 left-1/2 transform -translate-x-1/2 p-4 rounded-lg shadow-lg border max-w-md w-full ${
                    type === 'success' ? 'bg-green-100 text-green-800 border-green-400' :
                    type === 'error' ? 'bg-red-100 text-red-800 border-red-400' :
                    'bg-blue-100 text-blue-800 border-blue-400'
                }`;
                alertDiv.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span>${message}</span>
                        <button class="close-alert text-lg font-bold ml-4">Ã—</button>
                    </div>
                `;

                // Append to the document body
                document.body.appendChild(alertDiv);

                // Close alert on button click
                alertDiv.querySelector('.close-alert').addEventListener('click', () => {
                    alertDiv.remove();
                });

                // Auto-remove after 5 seconds
                setTimeout(() => {
                    alertDiv.remove();
                }, 5000);
            }

                document.getElementById('RefreshBtn').addEventListener('click', async () => {
                    await loadProgress();
                });
                async function loadProgress() {
                    try {
                        // Fetch data from the Supabase database
                        const { data, error } = await database_client
                            .from('schedule_workdone_table')
                            .select('uniqueId, workDone');

                        // Check for errors
                        if (error) {
                            showAlert('Error fetching progress from database: ' + error.message, 'error');
                            console.error('Error fetching progress from database:', error.message);
                            return;
                        }

                        // If data exists, update allTasks
                        if (data && data.length > 0) {
                            data.forEach(savedTask => {
                                const taskToUpdate = allTasks.find(t => t.uniqueId === savedTask.uniqueId);
                                if (taskToUpdate) {
                                    taskToUpdate.workDone = savedTask.workDone || 0;
                                }
                            });
                            renderAll();
                            showAlert('Progress loaded successfully!', 'success');
                        } else {
                            console.log('No progress data found in schedule_workdone_table');
                            showAlert('No progress data found in the database.', 'info');
                        }
                    } catch (err) {
                        console.error('Unexpected error while loading progress:', err);
                        showAlert('Unexpected error while loading progress: ' + err.message, 'error');
                    }
                }

                function renderAll() {
                    populateFilters();
                    filterTable();
                    renderWorkingDaysChart();
                    renderHistograms();
                    renderTeamProgressChart();
                    renderSCurveCharts();
                    renderFloorProgressChart();
                    renderUpcomingTasks();
                    updateOverallProgress();
                }

                function renderTable(data) {
                    const tableBody = document.getElementById('tableBody');
                    tableBody.innerHTML = '';
                    data.forEach(task => {
                        const progress = task.length > 0 ? (task.workDone / task.length) * 100 : 0;
                        
                        const row = `<tr data-task-id="${task.uniqueId}">
                            <td>${task.teamId}</td>
                            <td>${task.taskSequence}</td>
                            <td>${task.assignmentType}</td>
                            <td>${task.group}</td>
                            <td>${task.floor}</td>
                            <td>${task.length.toFixed(2)}</td>
                            <td>${formatDate(task.startDate)}</td>
                            <td>${formatDate(task.endDate)}</td>
                            <td>${task.workDone}</td>
                            <td class="progress-cell">
                                <div class="progress-bar-container"><div class="progress-bar" style="width: ${Math.min(100, progress)}%;"></div><span class="progress-text">${Math.round(progress)}%</span></div>
                            </td>
                        </tr>`;
                        tableBody.innerHTML += row;
                    });
                }
                
                const teamColors = [
                    '#a8d8ea', '#aa96da', '#fcbad3', '#ffffd2', '#a8e6cf', '#dcedc1', '#ffd3b6', '#ffaaa5',
                    '#8fbc8f', '#f08080', '#add8e6', '#dda0dd', '#90ee90', '#ffb6c1', '#b0c4de', '#ffefd5',
                    '#e0ffff', '#fafad2', '#d3d3d3', '#f5deb3', '#ffc0cb', '#c0d6e4', '#e6e6fa'
                ];

                function renderWorkingDaysChart() {
                    const container = document.getElementById('working-days-container');
                    let table = '<table class="working-days-table"><thead><tr><th>Team</th>';
                    const daysInMonth = 31;
                    for(let i = 1; i <= daysInMonth; i++) {
                        table += `<th>${i}</th>`;
                    }
                    table += '</tr></thead><tbody>';

                    teams.forEach(team => {
                        table += `<tr><td>Team ${team.id}</td>`;
                        let dailyTasks = new Array(daysInMonth).fill('');
                        team.tasks.forEach(task => {
                            for (let d = new Date(task.startDate); d <= task.endDate; d.setDate(d.getDate() + 1)) {
                                if(d.getMonth() === 6) { 
                                    dailyTasks[d.getDate() - 1] = task.id;
                                }
                            }
                        });
                        
                        dailyTasks.forEach(taskId => {
                            let cellStyle = '';
                            if(taskId) {
                                const color = teamColors[(team.id - 1) % teamColors.length];
                                cellStyle = `style="background-color: ${color};"`;
                            }
                            table += `<td class="working-day-cell" ${cellStyle} title="Installation Group: ${taskId || 'None'}">${taskId || ''}</td>`;
                        });
                        table += '</tr>';
                    });
                    
                    table += '</tbody></table>';
                    container.innerHTML = table;
                }

                function renderHistograms() {
                    const dailyData = {};
                    const firstDay = new Date('2025-07-01T00:00:00Z');
                    const lastDay = new Date('2025-07-31T00:00:00Z');

                    for (let d = new Date(firstDay); d <= lastDay; d.setDate(d.getDate() + 1)) {
                        dailyData[formatDate(d)] = { manpower: 0, equipment: 0 };
                    }

                    allTasks.forEach(task => {
                        for (let d = new Date(task.startDate); d <= task.endDate; d.setDate(d.getDate() + 1)) {
                            const dateStr = formatDate(d);
                            if(dailyData[dateStr]){
                                dailyData[dateStr].manpower += 2;
                                dailyData[dateStr].equipment += 1;
                            }
                        }
                    });

                    const labels = Object.keys(dailyData);
                    const manpowerData = Object.values(dailyData).map(d => d.manpower);
                    const equipmentData = Object.values(dailyData).map(d => d.equipment);
                    
                    if(manpowerChart) manpowerChart.destroy();
                    manpowerChart = new Chart(document.getElementById('manpowerChart'), {
                        type: 'bar',
                        data: { labels: labels, datasets: [{ label: 'Technicians per Day', data: manpowerData, backgroundColor: 'rgba(59, 130, 246, 0.5)' }] },
                        options: { scales: { y: { beginAtZero: true, title: { display: true, text: 'Daily Count' } } } }
                    });
                    
                    if(equipmentChart) equipmentChart.destroy();
                    equipmentChart = new Chart(document.getElementById('equipmentChart'), {
                        type: 'bar',
                        data: { labels: labels, datasets: [{ label: 'Scissor Lifts per Day', data: equipmentData, backgroundColor: 'rgba(239, 68, 68, 0.5)' }] },
                        options: { scales: { y: { beginAtZero: true, title: { display: true, text: 'Daily Count' } } } }
                    });
                }

                function renderTeamProgressChart() {
                    const teamData = {};
                    for (let i = 1; i <= TEAM_COUNT; i++) {
                        teamData[i] = { planned: 0, done: 0 };
                    }

                    allTasks.forEach(task => {
                        if(!teamData[task.teamId]) teamData[task.teamId] = { planned: 0, done: 0 };
                        teamData[task.teamId].planned += task.length;
                        teamData[task.teamId].done += task.workDone;
                    });

                    const labels = Object.keys(teamData).map(id => `Team ${id}`);
                    const plannedData = Object.values(teamData).map(d => d.planned.toFixed(2));
                    const doneData = Object.values(teamData).map(d => d.done.toFixed(2));

                    const ctx = document.getElementById('teamProgressChart');
                    if (teamProgressChart) teamProgressChart.destroy();
                    teamProgressChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [
                                { label: 'Planned (Lm)', data: plannedData, backgroundColor: 'rgba(59, 130, 246, 0.5)' },
                                { label: 'Work Done (Lm)', data: doneData, backgroundColor: 'rgba(34, 197, 94, 0.5)' }
                            ]
                        },
                        options: { scales: { y: { beginAtZero: true, title: { display: true, text: 'Linear Meters (Lm)' } } } }
                    });
                }

                function getSCurveData() {
                    const dailyData = {};
                    const firstDay = new Date('2025-07-01T00:00:00Z');
                    const lastDay = new Date(Math.max.apply(null, allTasks.map(t => t.endDate)));

                    for (let d = new Date(firstDay); d <= lastDay; d.setDate(d.getDate() + 1)) {
                        dailyData[formatDate(d)] = { planned: 0, actual: 0 };
                    }

                    allTasks.forEach(task => {
                        const duration = task.duration || 1;
                        const dailyPlanned = task.length / duration;
                        const dailyActual = task.workDone / duration;
                        for (let d = new Date(task.startDate); d <= task.endDate; d.setDate(d.getDate() + 1)) {
                            const dateStr = formatDate(d);
                            if(dailyData[dateStr]){
                                dailyData[dateStr].planned += dailyPlanned;
                                dailyData[dateStr].actual += dailyActual;
                            }
                        }
                    });

                    const labels = Object.keys(dailyData);
                    let cumulativePlanned = 0;
                    let cumulativeActual = 0;
                    const plannedCurve = labels.map(date => {
                        cumulativePlanned += dailyData[date].planned;
                        return cumulativePlanned;
                    });
                    const actualCurve = labels.map(date => {
                        cumulativeActual += dailyData[date].actual;
                        return cumulativeActual;
                    });
                    
                    return { labels, plannedCurve, actualCurve };
                }

                function renderSCurveCharts() {
                    const { labels, plannedCurve, actualCurve } = getSCurveData();
                    const data = {
                        labels: labels,
                        datasets: [
                            { label: 'Planned Cumulative (Lm)', data: plannedCurve, borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.1 },
                            { label: 'Actual Cumulative (Lm)', data: actualCurve, borderColor: '#22c55e', backgroundColor: 'rgba(34, 197, 94, 0.1)', fill: true, tension: 0.1 }
                        ]
                    };
                    const options = {
                        scales: {
                            x: { type: 'time', time: { unit: 'day' }, title: { display: true, text: 'Date' } },
                            y: { beginAtZero: true, title: { display: true, text: 'Cumulative Linear Meters (Lm)' } }
                        }
                    };
                    
                    const ctxDashboard = document.getElementById('sCurveChartDashboard');
                    if (sCurveChartDashboard) sCurveChartDashboard.destroy();
                    sCurveChartDashboard = new Chart(ctxDashboard, { type: 'line', data, options });

                    const ctxDetail = document.getElementById('sCurveChartDetail');
                    if (sCurveChartDetail) sCurveChartDetail.destroy();
                    sCurveChartDetail = new Chart(ctxDetail, { type: 'line', data, options });
                }

                function renderFloorProgressChart() {
                    const floorData = {};
                    allTasks.forEach(task => {
                        if(!floorData[task.floor]) floorData[task.floor] = { planned: 0, done: 0 };
                        floorData[task.floor].planned += task.length;
                        floorData[task.floor].done += task.workDone;
                    });

                    const labels = Object.keys(floorData).sort();
                    const progressData = labels.map(floor => {
                        const data = floorData[floor];
                        return data.planned > 0 ? (data.done / data.planned) * 100 : 0;
                    });

                    const ctx = document.getElementById('floorProgressChart');
                    if (floorProgressChart) floorProgressChart.destroy();
                    floorProgressChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Completion %',
                                data: progressData,
                                backgroundColor: teamColors
                            }]
                        },
                        options: {
                            indexAxis: 'y',
                            scales: { x: { beginAtZero: true, max: 100, title: { display: true, text: 'Completion Percentage' } } }
                        }
                    });
                }
                
                function renderUpcomingTasks() {
                    const container = document.getElementById('upcomingTasks');
                    const today = new Date();
                    const nextWeek = addDays(today, 7);
                    const upcoming = allTasks.filter(t => t.startDate >= today && t.startDate <= nextWeek).sort((a,b) => a.startDate - b.startDate);
                    
                    if(upcoming.length === 0){
                        container.innerHTML = '<p class="text-gray-500">No tasks starting in the next 7 days.</p>';
                        return;
                    }

                    let table = '<table class="w-full text-sm"><thead><tr class="text-left"><th class="py-1">Date</th><th class="py-1">Group</th><th class="py-1">Team</th></tr></thead><tbody>';
                    upcoming.forEach(task => {
                        table += `<tr class="border-t"><td class="py-1">${formatDate(task.startDate)}</td><td class="py-1">${task.group}</td><td class="py-1">${task.teamId}</td></tr>`;
                    });
                    table += '</tbody></table>';
                    container.innerHTML = table;
                }

                window.updateProgress = (element, taskId) => {
                    const task = allTasks.find(t => t.uniqueId === taskId);
                    if (!task) return;
                    let value = parseFloat(element.value);
                    if (isNaN(value) || value < 0) value = 0;
                    if (value > task.length) { value = task.length; element.value = value.toFixed(2); }
                    task.workDone = value;
                    const row = element.closest('tr');
                    const progressBar = row.querySelector('.progress-bar');
                    const progressText = row.querySelector('.progress-text');
                    const percentage = task.length > 0 ? (task.workDone / task.length) * 100 : 0;
                    progressBar.style.width = `${Math.min(100, percentage)}%`;
                    progressText.textContent = `${Math.round(percentage)}%`;
                    updateOverallProgress();
                    renderTeamProgressChart();
                    renderSCurveCharts();
                    renderFloorProgressChart();
                }

                function updateOverallProgress() {
                    const totalPlanned = allTasks.reduce((sum, task) => sum + task.length, 0);
                    const totalDone = allTasks.reduce((sum, task) => sum + task.workDone, 0);
                    const overallPercentage = totalPlanned > 0 ? (totalDone / totalPlanned) * 100 : 0;
                    document.getElementById('totalPlanned').textContent = `${totalPlanned.toFixed(2)} Lm`;
                    document.getElementById('totalDone').textContent = `${totalDone.toFixed(2)} Lm`;
                    document.getElementById('overallProgressBar').style.width = `${overallPercentage}%`;
                    document.getElementById('overallProgressText').textContent = `${Math.round(overallPercentage)}%`;
                }

                // --- UI LOGIC ---
                function openTab(evt, tabName) {
                    let i, tabcontent, tabbuttons;
                    tabcontent = document.getElementsByClassName("tab-content");
                    for (i = 0; i < tabcontent.length; i++) {
                        tabcontent[i].style.display = "none";
                    }
                    tabbuttons = document.querySelectorAll("#tabs-container .tab-button");
                    for (i = 0; i < tabbuttons.length; i++) {
                        tabbuttons[i].className = tabbuttons[i].className.replace(" active", "");
                    }
                    document.getElementById(tabName).style.display = "block";
                    evt.currentTarget.className += " active";
                }
                
                function populateFilters() {
                    const teamFilter = document.getElementById('teamFilter');
                    const floorFilter = document.getElementById('floorFilter');
                    const groupFilter = document.getElementById('groupFilter');

                    const teams = [...new Set(allTasks.map(t => t.teamId))].sort((a,b) => a - b);
                    const floors = [...new Set(allTasks.map(t => t.floor))].sort();
                    const groups = [...new Set(allTasks.map(t => t.group))].sort((a,b) => a - b);

                    teams.forEach(val => teamFilter.innerHTML += `<option value="${val}">Team ${val}</option>`);
                    floors.forEach(val => floorFilter.innerHTML += `<option value="${val}">${val}</option>`);
                    groups.forEach(val => groupFilter.innerHTML += `<option value="${val}">${val}</option>`);
                }
                
                function filterTable() {
                    const teamFilter = document.getElementById('teamFilter').value;
                    const floorFilter = document.getElementById('floorFilter').value;
                    const groupFilter = document.getElementById('groupFilter').value;
                    
                    const filteredTasks = allTasks.filter(task => {
                        const teamMatch = (teamFilter === 'All' || task.teamId == teamFilter);
                        const floorMatch = (floorFilter === 'All' || task.floor === floorFilter);
                        const groupMatch = (groupFilter === 'All' || task.group == groupFilter);
                        return teamMatch && floorMatch && groupMatch;
                    });
                    renderTable(filteredTasks);
                }
                
                let sortDirections = {};
                function sortTable(n) {
                    const table = document.getElementById("scheduleTable");
                    const dir = sortDirections[n] === 'asc' ? 'desc' : 'asc';
                    sortDirections = { [n]: dir };
                    const tbody = table.querySelector('tbody');
                    const rows = Array.from(tbody.rows);
                    
                    rows.sort((a, b) => {
                        const x = a.cells[n].textContent.toLowerCase();
                        const y = b.cells[n].textContent.toLowerCase();
                        
                        const numX = parseFloat(x);
                        const numY = parseFloat(y);

                        if (!isNaN(numX) && !isNaN(numY)) {
                            return (numX - numY) * (dir === 'asc' ? 1 : -1);
                        }

                        if (x < y) return dir === 'asc' ? -1 : 1;
                        if (x > y) return dir === 'asc' ? 1 : -1;
                        return 0;
                    });

                    rows.forEach(row => tbody.appendChild(row));
                }

                // --- INITIALIZATION ---
                document.addEventListener('DOMContentLoaded', () => {
                    loadProgress();
                });
                teams = calculateSchedule();
                allTasks = processTasks(teams);
                loadProgress();

                // Add event listeners programmatically
                document.querySelectorAll('#tabs-container .tab-button').forEach(button => {
                    button.addEventListener('click', (event) => openTab(event, button.dataset.tab));
                });
                document.getElementById('teamFilter').addEventListener('change', filterTable);
                document.getElementById('floorFilter').addEventListener('change', filterTable);
                document.getElementById('groupFilter').addEventListener('change', filterTable);
                document.getElementById('clearFiltersBtn').addEventListener('click', () => {
                    document.getElementById('teamFilter').value = 'All';
                    document.getElementById('floorFilter').value = 'All';
                    document.getElementById('groupFilter').value = 'All';
                    filterTable();
                });
                document.querySelectorAll('#scheduleTable thead th').forEach(th => {
                    th.addEventListener('click', () => {
                        const index = th.getAttribute('data-sort-index');
                        if(index) {
                            sortTable(parseInt(index));
                        }
                    });
                });
                // Need to use event delegation for the work-done-input since rows are re-rendered
                document.getElementById('tableBody').addEventListener('input', function(e) {
                    if (e.target && e.target.classList.contains('work-done-input')) {
                        const taskId = e.target.closest('tr').dataset.taskId;
                        updateProgress(e.target, taskId);
                    }
                });
            })();
            </script>
</body>
</html>
